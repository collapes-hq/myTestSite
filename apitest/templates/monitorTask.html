{% extends 'base.html' %}
{% load static %}
{% load extra_tags %}
{% block title %}
    监控任务
{% endblock %}
{% block css %}
    <link rel="stylesheet" href="{% static 'css/dataTables.bootstrap4.min.css' %}">
    <style type="text/css">
        .table th {
            vertical-align: middle;
        }

        th {
            font-weight: normal;

        }

        .btn {
            line-height: 1.5;
            font-size: 1rem;
        }
    </style>
{% endblock %}
{% block content %}


    <div class="container-fluid">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-2">
                        <select name="" id="" class="form-control">
                            <option value="0" selected>全部业务线</option>
                            <option value="1">大数据部</option>
                            <option value="3">技术中台部</option>
                        </select>
                    </div>
                    <div class="col-3">
                        <input type="text" class="form-control" id="inputkey" placeholder="请输入要查询的任务名">
                    </div>
                    <div class="col-3 ">

                        <button class="btn btn-primary mr-1" id="searchbutton"><i class="fa fa-search"
                                                                                  aria-hidden="true"></i> 搜索
                        </button>
                        <button class="btn btn-success"><i class="fa fa-plus" aria-hidden="true"></i> 新建任务</button>
                    </div>
                </div>

                <div class="mt-2">

                    <table class="table table-bordered table-hover " id="tasktable">
                        <thead>
                        <tr>
                            <th>业务线</th>
                            <th>任务名称</th>
                            <th>接口用例数</th>
                            <th>执行类型</th>
                            <th>更新时间</th>
                            <th>执行结果</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for task in tasks %}
                            <tr>
                                <th>{{ task.monitorTask_busi.busi_name }}</th>
                                <th>{{ task.monitorTask_name }}</th>
                                <th>{{ task.monitorTask_caseList|strToList|length }}</th>
                                <th>{{ task.get_monitorTask_type_display }}</th>
                                <th>{{ task.monitorTask_c_time|date:"Y/m/d H:m:s" }}</th>
                                <th><span class="text-success">{{ task.monitorTask_id|getSuccessSum }}</span> | <span class="text-danger">{{ task.monitorTask_id|getFailureSum }}</span></th>
                                <th>
                                    <div class="btn-group btn-group-justified " role="group" aria-label="...">
                                        <div class="btn-group mr-1" role="group">
                                            <a href=# class="" id="execTask">手动执行</a>
                                        </div>
                                        <div class="btn-group mr-1" role="group">
                                            <a href="{% url 'apitest:taskDetail' task.monitorTask_id %}"
                                               class="">执行详情</a>
                                        </div>
                                    </div>
                                </th>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <div class="modal fade" id="taskModal" tabindex="-1" role="dialog" aria-labelledby="caseModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <p class="text-center mb-0" id="info">
                            <i class="fa fa-check-circle text-success mr-1" aria-hidden="true"></i>
                                手动执行任务已提交，请进入任务详情页面查看
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script src="{% static 'vendor/bootstrap/js/jquery.dataTables.js' %}"></script>
    <script src="{% static 'vendor/bootstrap/js/dataTables.bootstrap4.min.js' %}"></script>
    <script>
        var table;
        $(function () {
            table = $('#tasktable').dataTable({
                "dom": '<"top">rt<"bottom"f>p<"clear">',
                searching: true,
                processing: false,
                ordering: false,
                lengthChange: false,
                info: true,
                // paging: false,
                language: {
                    "sProcessing": "处理中...",
                    "sLengthMenu": "显示 _MENU_ 项结果",
                    "sZeroRecords": "没有匹配结果",
                    "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                    "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                    "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                    "sInfoPostFix": "",
                    "sSearch": "搜索:",
                    "sUrl": "",
                    "sEmptyTable": "表中数据为空",
                    "sLoadingRecords": "载入中...",
                    "sInfoThousands": ",",
                    "oPaginate": {
                        "sFirst": "首页",
                        "sPrevious": "上页",
                        "sNext": "下页",
                        "sLast": "末页"
                    },
                    "oAria": {
                        "sSortAscending": ": 以升序排列此列",
                        "sSortDescending": ": 以降序排列此列"
                    }
                },

            }).api();


        });


        $('#searchbutton').click(function () {
            let value = $('#inputkey').val();
            table.search(value).draw();
        });
        //jquery委托事件--按钮操作获取当前行的相关数据
        $('tbody').on('click', '#execTask', function () {
            let form_value = [];
            $(this).parent().parent().parent().parent().children('th').each(function () {
                form_value.push($(this).text());
            });
            var task_name = form_value[1];
            console.log(task_name.replace(/(\s*$)/g, ""));
            $.ajax({
                async: true,
                type:'GET',
                url: '/api/manualExecTask/',
                data: {'task_name': task_name},
                success: function () {
                    $('#taskModal').modal('show');
                    setTimeout("$('#taskModal').modal('hide')", 5000)
                }
            })

        })

    </script>
{% endblock %}